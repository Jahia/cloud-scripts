---
type: update
version: 1.5.2
name: Jahia - Digital Experience Manager
logo: /images/jahia-logo-70x70.png
id: upgrade-v1.5

onInstall:
  - if (nodes.proc):  # Jahia
      - healthcheckOnHaproxy  # PAAS-1078
      - fixMariaDbMaxOpenFiles  # PAAS-1093
  - else:  # Unomi
      - fixUnomiRestart
      - checkElasticsearchBeforeStartKaraf  # PAAS-897 & PAAS-1084
      - addVolumeForEsData  # PAAS-1087

actions:
  fixUnomiRestart:
    - cmd[cp]: |-
        mkdir -p /var/lib/jelastic/overrides
        echo "SERVICE='karaf';" >> /var/lib/jelastic/overrides/envinfo.lib
        echo "DATA_OWNER='karaf:karaf';" >> /var/lib/jelastic/overrides/envinfo.lib
      user: root

  checkElasticsearchBeforeStartKaraf:
    - cmd[cp]: |-
        pre_start_cmd=$(grep ExecStartPre /etc/systemd/system/karaf.service)
        if [ "$pre_start_cmd" == "" ]; then
          string="ExecStartPre=/bin/bash -c \"i=666; until (curl 'http://es:9200/_cluster/health?pretty' -s | egrep -q '.status. : .(green|yellow).'); do ((i--)); if [ $i -eq 0 ]; then exit 66; fi; sleep 1; done\""
          sed "11i$string\n" -i /etc/systemd/system/karaf.service
        else
          sed -i 's/\(ExecStartPre.*\)\.green\.\(.*\)/\1.(green|yellow).\2/g' /etc/systemd/system/karaf.service
        fi
        systemctl daemon-reload
        exit $?
      user: root

  healthcheckOnHaproxy:
    - cmd[bl]: |-
        cp /etc/haproxy/haproxy.cfg.d/00-global.cfg /root/00-global.cfg.bak
        sed -ie '/\!tools #HTTP_AUTH_BASIC/a\\n    acl healthcheck path /healthcheck\n    http-request allow if healthcheck' /etc/haproxy/haproxy.cfg.d/00-global.cfg
        service haproxy reload
      user: root

  addVolumeForEsData:
    - api: environment.control.addcontainervolumebygroup
      nodeGroup: es
      path: /var/lib/elasticsearch
      envName: ${env.envName}

  fixMariaDbMaxOpenFiles:
    - cmd[sqldb]: |-
        mkdir /etc/systemd/system/{mysql,mariadb}.service.d
        echo -e "[Service]\nLimitNOFILE=524290" | tee /etc/systemd/system/{mysql,mariadb}.service.d/override.conf
