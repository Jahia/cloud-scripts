---
type: update
version: 1.5.2
name: Update v3.2.0
logo: /images/jahia-logo-70x70.png
id: update-v3.2.0

onInstall:
  - if (nodes.proc):  # Jahia
      - jahiaPropertiesToEnvVars
      - jahiaRollingRestart
      - haproxyLogs
      - if (nodes.sqldb.length > 1):
          - increaseGaleraCacheSize
          - galeraRollingRestart
  - else:  # Unomi
      log: Nothing to do

actions:
  # https://jira.jahia.org/browse/PAAS-1002 changes were never applied to existing environments
  # For instance Arkema's environments
  # I prefer adding these values to jahia.properties before "moving" them to envvars in case we have to
  # revert these changes for some reasons
  fixMissingEhcacheValues:
    - cmd [proc]: |-
        grep -q org.jahia.ehcachemanager $STACK_PATH/conf/digital-factory-config/jahia/jahia.properties || echo $jahia_cfg_operatingMode
    - set:
        operatingMode: "${response.out}"
    - if ("${this.operatingMode}" != ""): # if the ehcachemanager values are not found in jahia.properties
        - if ("${this.operatingMode}" == "production"):
            - set:
                jahia_cfg_org_jahia_ehcachemanager_maxBytesLocalHeap: 800M
                jahia_cfg_org_jahia_ehcachemanager_big_maxBytesLocalHeap_cp: 2500M
                jahia_cfg_org_jahia_ehcachemanager_big_maxBytesLocalHeap_proc: 700M
        - else:
            - set:
                jahia_cfg_org_jahia_ehcachemanager_maxBytesLocalHeap: 700M
                jahia_cfg_org_jahia_ehcachemanager_big_maxBytesLocalHeap_cp: 700M
                jahia_cfg_org_jahia_ehcachemanager_big_maxBytesLocalHeap_proc: 700M
        - cmd [proc]: |-
            echo "org.jahia.ehcachemanager.maxBytesLocalHeap=${this.jahia_cfg_org_jahia_ehcachemanager_maxBytesLocalHeap}" \
              >> $STACK_PATH/conf/digital-factory-config/jahia/jahia.properties
            echo "org.jahia.ehcachemanager.big.maxBytesLocalHeap=${this.jahia_cfg_org_jahia_ehcachemanager_big_maxBytesLocalHeap_proc}" \
              >> $STACK_PATH/conf/digital-factory-config/jahia/jahia.properties
        - cmd [cp]: |-
            echo "org.jahia.ehcachemanager.maxBytesLocalHeap=${this.jahia_cfg_org_jahia_ehcachemanager_maxBytesLocalHeap}" \
              >> $STACK_PATH/conf/digital-factory-config/jahia/jahia.properties
            echo "org.jahia.ehcachemanager.big.maxBytesLocalHeap=${this.jahia_cfg_org_jahia_ehcachemanager_big_maxBytesLocalHeap_cp}" \
              >> $STACK_PATH/conf/digital-factory-config/jahia/jahia.properties

  jahiaPropertyToEnvVar:
    - cmd [proc]: |-
        PROPERTIES_FILE=/opt/tomcat/conf/digital-factory-config/jahia/jahia.properties
        ENVVAR=${this}
        PROPERTY_KEY="$(echo $ENVVAR | sed "s;jahia_cfg_;;" | sed "s;_;.;g")"
        if ! grep -wq $ENVVAR /.jelenv; then
          PROPERTY_VALUE=$(grep -E "^ *$PROPERTY_KEY *=" $PROPERTIES_FILE | sed "s;.*= *\(.*\);\1;")
          [ "$PROPERTY_VALUE" = "" ] && echo "Cannot retrieve value of $PROPERTY_VALUE" && exit 1
          echo $PROPERTY_VALUE && exit 0
        fi
        eval "echo \${$ENVVAR}"
      user: root
    - env.control.AddContainerEnvVars [cp, proc]:
      vars:
        ${this}: ${response.out}
    - cmd [proc]: |-
        PROPERTIES_FILE=/opt/tomcat/conf/digital-factory-config/jahia/jahia.properties
        ENVVAR=${this}
        PROPERTY_KEY="$(echo $ENVVAR | sed "s;jahia_cfg_;;" | sed "s;_;.;g")"
        sed -i "s|^\( *$PROPERTY_KEY *=.*\)|#\1|" $PROPERTIES_FILE || exit 1

  jahiaPropertiesToEnvVars:
    - fixMissingEhcacheValues
    - jahiaPropertyToEnvVar: jahia_cfg_jahiaFileUploadMaxSize
    - jahiaPropertyToEnvVar: jahia_cfg_imageService
    - jahiaPropertyToEnvVar: jahia_cfg_imageMagickPath
    - jahiaPropertyToEnvVar: jahia_cfg_mvnPath
    - jahiaPropertyToEnvVar: jahia_cfg_expandImportedFilesOnDisk
    - jahiaPropertyToEnvVar: jahia_cfg_org_jahia_ehcachemanager_maxBytesLocalHeap
    - jahiaPropertyToEnvVar: jahia_cfg_org_jahia_ehcachemanager_big_maxBytesLocalHeap

  jahiaRollingRestart:
    install:
      jps: "https://raw.githubusercontent.com/Jahia/paas_jelastic_dx_universal/master/jahia/jahia-rolling-restart.yml"

  haproxyLogs:
    cmd[bl]: |-
      already_done=$(grep haproxy-status /etc/datadog-agent/conf.d/haproxy.d/conf.yaml)
      if [ "$already_done" = "" ]; then
        wget -qO /etc/logrotate.d/haproxy ${baseUrl}/logrotate_haproxy
        chmod 644 /etc/logrotate.d/haproxy
        wget -qO /tmp/dd_agent_haproxy_conf_new_lines.yml ${baseUrl}/dd_agent_haproxy_conf_new_lines.yml
        sed -i '/http_web_access/r /tmp/dd_agent_haproxy_conf_new_lines.yml' /etc/datadog-agent/conf.d/haproxy.d/conf.yaml
        rm /tmp/dd_agent_haproxy_conf_new_lines.yml
        systemctl restart datadog-agent
      fi
    user: root

  increaseGaleraCacheSize:
    cmd [sqldb]:
      sed -i '/^wsrep_provider_options =.*/d' /etc/mysql/conf.d/galera.cnf
      sed -i '/^wsrep_provider =.*/a wsrep_provider_options = "gcache.size=256M"' /etc/mysql/conf.d/galera.cnf

  galeraRollingRestart:
    install:
      jps: "${baseUrl}/../../galera-nodes/restart-galera-nodes.yml"
