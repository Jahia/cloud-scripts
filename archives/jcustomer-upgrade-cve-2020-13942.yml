---
type: update
version: 1.5.2
name: Upgrade jCustomer to patched version
logo: /images/jahia-logo-70x70.png
id: jcustomer-upgrade-cve-2020-13942
description: 
  short: Upgrade jCustomer because of CVE-2020-13942 [COPS-199]

globals:
  jcustomer_upgrade_package: "https://raw.githubusercontent.com/Jahia/paas_jelastic_unomi/master/unomi_upgrade.yml"

onInstall:
  - if (nodes.es):
      - setGlobals:
          target_version: ""
      - if ("${nodes.cp.first.version}" < "1.4.4"):
          - redeployJcustomerNodes: 1.4.4
      - elif ("${nodes.cp.first.version}" > "1.5" && "${nodes.cp.first.version}" < "1.5.4"):
          - redeployJcustomerNodes: 1.5.4
      - else:
          - log: Already patched (version ${nodes.cp.first.version}), nothing to do.

actions:
  redeployJcustomerNodes:
    - script: |-
        data = {
          "targetAppid": "${env.appid}",
          "manifest": "${globals.jcustomer_upgrade_package}",
          "settings": {
            "targetVersion": "${this}",
            "packageType": "dev"
            }
          }
        res = jelastic.dev.scripting.eval("appstore", session, "InstallApp", data)
        return res
