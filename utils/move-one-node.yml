---
type: install
version: 1.5.2
name: Move one node to another HN
logo: /images/jahia-logo-70x70.png
id: move-node-between-hn


# In order to update theses HNs lists, only way I found is
# to use jelastic.administration.cluster.gethdnodes
# with an admin user :/
# id is jelastic.administration.cluster.gethdnodes.[*].id

onBeforeInit: |-
  var devHNList = {
    "7": "hn01 - AWS - eu-west-1 - m5.2xlarge",
    "3": "hn02 - AWS - eu-west-1 - m5.2xlarge",
    "13": "hn03 - AWS - eu-west-1 - m5.2xlarge",
    "14": "hn04 - AWS - eu-west-1 - m5.2xlarge",
    "15": "hn05 - AWS - eu-west-1 - m5.2xlarge",
    "18": "hn07 - Azure - North Europe - Standard D8s v3",
    "23": "hn06 - Azure - North Europe - Standard D8s v3"
    }

  var prodHNList = {
    "12": "hn01 - AWS - us-east-1 - m5.4xlarge",
    "13": "hn02 - AWS - us-east-1 - m5.4xlarge",
    "14": "hn03 - AWS - us-east-1 - m5.4xlarge",
    "15": "hn04 - AWS - us-east-1 - m5.4xlarge",
    "16": "hn05 - AWS - us-east-1 - m5.4xlarge",
    "18": "hn06 - Azure - Central US Standard D16s v3",
    "19": "hn07 - Azure - Central US Standard D16s v3",
    "20": "hn08 - Azure - Central US Standard D16s v3",
    "21": "hn09 - Azure - Central US Standard D16s v3",
    "22": "hn10 - Azure - Central US Standard D16s v3",
    "24": "hn11 - AWS - eu-west-1 - m5.4xlarge",
    "25": "hn12 - AWS - eu-west-1 - m5.4xlarge",
    "26": "hn13 - AWS - eu-west-1 - m5.4xlarge",
    "27": "hn14 - AWS - eu-west-1 - m5.4xlarge",
    "28": "hn15 - AWS - us-east-1 - m5.4xlarge",
    "29": "hn16 - AWS - us-east-1 - m5.4xlarge",
    "30": "hn17 - AWS - us-east-1 - m5.4xlarge",
    "31": "hn18 - AWS - us-east-1 - m5.4xlarge",
    "36": "hn19 - AWS - eu-west-1 - m5.4xlarge",
    "35": "hn20 - AWS - eu-west-1 - m5.4xlarge",
    "37": "hn21 - OVH - fr-gra2 - infra-3",
    "38": "hn22 - OVH - fr-gra2 - infra-3",
    "42": "hn23 - OVH - fr-gra2 - infra-3",
    "45": "hn24 - AWS - eu-west-1 - i3en.2xlarge"
    }

  envsArray = jelastic.environment.control.getenvs("appstore", session)["infos"]

  regions = jelastic.environment.control.getregions("cluster", session).array
  for (var region = 0; region < regions.length; region++) {
    if (regions[region].domain == "dev.j.jahia.com") {
      var listArray = devHNList
      break
    } else if (regions[region].domain == "cloud.jahia.com") {
      var listArray = prodHNList
      break
    }
  }

  var nodesArray = {}
  var envArray = {}
  var ngArray = {}

  for (var i = 0; i < envsArray.length; i++) {
    envname = envsArray[i].env.envName

    for (var j = 0; j < envsArray[i].nodes.length; j++) {
      nodegroup = envsArray[i].nodes[j].nodeGroup
      nodeid = envsArray[i].nodes[j].id

      caption = envname + " " + nodegroup + " " + nodeid
      nodesArray[nodeid] = caption
      var e = {}
      e[envname] = envname
      envArray[nodeid] = e
      var g = {}
      g[nodegroup] = nodegroup
      ngArray[nodeid] = g
    }
  }

  return {
    result: 0,
    settings : {
      fields: [
        {
          type: "list",
          name: "nodeID",
          caption: "NodeID to move",
          values: nodesArray
        },
        {
          type: "toggle",
          caption: "Do you want stop node's env first ?",
          name: "stop",
          value: false,
        },
        {
          type: "list",
          name: "nodeEnv",
          caption: "node's env",
          dependsOn: {
            nodeID:
              envArray
          }
        },
        {
          type: "list",
          name: "nodeHg",
          caption: "node's hostgroup",
          dependsOn: {
            nodeID:
              ngArray
          }
        },
        {
          type: "list",
          caption: "move to",
          name: "hnTarget",
          values: listArray
        },
        {
          type: "toggle",
          caption: "Do you want FRO ?",
          name: "fro",
          value: false,
          showIf: {
            true: [
              {
                type: "envlist",
                caption: "FRO on which env ?",
                name: "envFRO",
                valueField: "shortdomain"
              }
            ]
          }
        }
      ]
    }
  }

onInstall:
  - if(${settings.fro}):
      - froStatus:
          enableFRO: true
  - if(${settings.stop}):
      - log: "Stopping env ${settings.nodeEnv}"
      - envStatus:
          stopEnv: true
  - log: "Moving nodeID ${settings.nodeID} (from ${settings.nodeEnv}'s ${settings.nodeHg}) to HN ID ${settings.hnTarget}"
  - moveNode
  - if(${settings.stop}):
      - log: "Starting env ${settings.nodeEnv}"
      - envStatus:
          stopEnv: false
  - if(${settings.fro}):
      - froStatus:
          enableFRO: false

actions:
  moveNode:
    - administration.cluster.migratenode [${settings.nodeID}]:
      appid: cluster
      hdnodeid: ${settings.hnTarget}
      isonline: false

  froStatus:
    - log: "## Set FRO mode on ${settings.envFRO} to ${this.enableFRO}"
    - if(${this.enableFRO}):
        - install:
            jps: "${baseUrl}/jahia-full-read-only.yml"
            settings:
              enableFRO: ${this.enableFRO}
            params:
              envName: "${settings.envFRO}"
    - else:
        - install:
            jps: "${baseUrl}/jahia-full-read-only.yml"
            params:
              envName: "${settings.envFRO}"

  envStatus:
    - install:
        jps: "${baseUrl}/stop-start-env.yml"
        settings:
          stop: ${this.stopEnv}
          env: "${settings.nodeEnv}"
