---
type: install
version: 1.5.2
name: Move one node to another HN
logo: /images/jahia-logo-70x70.png
id: move-node-between-hn


onBeforeInit: |-
  hnArray = jelastic.administration.cluster.gethdnodes("cluster", session).array
  envsArray = jelastic.environment.control.getenvs("appstore", session)["infos"]

  var listArray = {}
  var nodesArray = {}
  var envArray = {}
  var ngArray = {}

  for (var i = 0; i < hnArray.length; i++) {
    if (hnArray[i].hostname.match(/^hn[0-9]/)) {
      listArray[hnArray[i].id] = hnArray[i].hostname
    }
  }

  for (var i = 0; i < envsArray.length; i++) {
    envname = envsArray[i].env.envName

    for (var j = 0; j < envsArray[i].nodes.length; j++) {
      nodegroup = envsArray[i].nodes[j].nodeGroup
      nodeid = envsArray[i].nodes[j].id

      caption = envname + " " + nodegroup + " " + nodeid
      nodesArray[nodeid] = caption
      var e = {}
      e[envname] = envname
      envArray[nodeid] = e
      var g = {}
      g[nodegroup] = nodegroup
      ngArray[nodeid] = g
    }
  }

  return {
    result: 0,
    settings : {
      fields: [
        {
          type: "list",
          name: "nodeID",
          caption: "NodeID to move",
          values: nodesArray
        },
        {
          type: "toggle",
          caption: "Do you want stop node's env first ?",
          name: "stop",
          value: false,
        },
        {
          type: "list",
          name: "nodeEnv",
          caption: "node's env",
          dependsOn: {
            nodeID:
              envArray
          }
        },
        {
          type: "list",
          name: "nodeHg",
          caption: "node's hostgroup",
          dependsOn: {
            nodeID:
              ngArray
          }
        },
        {
          type: "list",
          caption: "move to",
          name: "hnTarget",
          values: listArray
        },
        {
          type: "toggle",
          caption: "Do you want FRO ?",
          name: "fro",
          value: false,
          showIf: {
            true: [
              {
                type: "envlist",
                caption: "FRO on which env ?",
                name: "envFRO",
                valueField: "shortdomain"
              }
            ]
          }
        }
      ]
    }
  }

onInstall:
  - if(${settings.fro}):
      - froStatus:
          enableFRO: true
  - if(${settings.stop}):
      - log: "Stopping env ${settings.nodeEnv}"
      - envStatus:
          stopEnv: true
  - log: "Moving nodeID ${settings.nodeID} (from ${settings.nodeEnv}'s ${settings.nodeHg}) to HN ID ${settings.hnTarget}"
  - moveNode
  - if(${settings.stop}):
      - log: "Starting env ${settings.nodeEnv}"
      - envStatus:
          stopEnv: false
  - if(${settings.fro}):
      - froStatus:
          enableFRO: false

actions:
  moveNode:
    - administration.cluster.migratenode [${settings.nodeID}]:
      appid: cluster
      hdnodeid: ${settings.hnTarget}
      isonline: false

  froStatus:
    - log: "## Set FRO mode on ${settings.envFRO} to ${this.enableFRO}"
    - install:
        jps: "${baseUrl}/jahia-full-read-only.yml"
        settings:
          enableFRO: ${this.enableFRO}
        params:
          envName: "${settings.envFRO}"

  envStatus:
    - install:
        jps: "${baseUrl}/stop-start-env.yml"
        settings:
          stop: ${this.stopEnv}
          env: "${settings.nodeEnv}"
